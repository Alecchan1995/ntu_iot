<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å•†å“ç®¡ç†å¾Œå°ï¼ˆEmail ç™»å…¥ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f4f4f5; margin: 0; padding: 20px; }
    .container { max-width: 980px; margin: 0 auto; background: #ffffff; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    h1 { margin: 0 0 4px 0; font-size: 22px; text-align: center; }
    .subtitle { text-align: center; color: #6b7280; font-size: 13px; margin-bottom: 16px; }
    a.link { color: #2563eb; text-decoration: none; font-size: 13px; }
    a.link:hover { text-decoration: underline; }
    .card { border-radius: 12px; border: 1px solid #e5e7eb; padding: 16px; margin-top: 16px; background: #f9fafb; }
    .card-title { font-size: 16px; margin-bottom: 10px; font-weight: 600; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .form-row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; }
    .field { flex: 1; min-width: 160px; }
    .field label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 2px; }
    .field input, .field textarea { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px; box-sizing: border-box; }
    .field textarea { min-height: 36px; resize: vertical; }
    .btn { border: none; border-radius: 999px; padding: 6px 12px; font-size: 13px; cursor: pointer; margin-right: 4px; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-danger  { background: #dc2626; color: #fff; }
    .btn-secondary { background: #6b7280; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    thead { background: #f3f4f6; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    tr:nth-child(even) td { background-color: #fafafa; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #4338ca; white-space: nowrap; }
    .badge-warn{ background:#fef3c7; color:#92400e; margin-left:8px; }
    .qty-ok { color: #15803d; }
    .qty-low { color: #ca8a04; }
    .qty-out { color: #b91c1c; }
    #status { margin-top: 10px; font-size: 12px; color: #6b7280; text-align: right; }
    #manage-area { display: none; }
    .hint { font-size: 12px; color:#6b7280; margin-top: 6px; line-height: 1.5; }
  
    tr.clickable { cursor: pointer; }
    tr.clickable:hover td { background: #f3f4f6; }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal {
      width: min(760px, 100%);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
    }
    .modal-close {
      border: none;
      background: #111827;
      color: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-body {
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      font-size: 14px;
    }
    .k { color: #6b7280; }
    .v { color: #111827; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }

  </style>
</head>
<body>
  <div class="container">
    <h1>å•†å“ç®¡ç†å¾Œå°</h1>
    <div class="subtitle">
      ä½¿ç”¨ Email / å¯†ç¢¼ç™»å…¥å¾Œæ‰èƒ½ä¿®æ”¹ Realtime Database çš„ <code>product</code> / <code>racks</code>ã€‚<br />
      <a class="link" href="IOT.html" target="_blank">ğŸ‘‰ å‰å¾€é¡¯ç¤ºé é¢ï¼ˆåº«å­˜çœ‹æ¿ï¼‰</a>
    </div>

    <div class="card" id="login-area">
      <div class="card-title">ç®¡ç†è€…ç™»å…¥</div>
      <div class="form-row">
        <div class="field">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="ä¾‹å¦‚ï¼šadmin@ntu-iot.com" />
        </div>
        <div class="field">
          <label for="login-password">å¯†ç¢¼</label>
          <input type="password" id="login-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
        </div>
      </div>
      <button class="btn btn-primary" id="login-btn">ç™»å…¥</button>
      <span id="login-msg" style="font-size:12px;color:#b91c1c;margin-left:8px;"></span>
    </div>

    <div id="manage-area">
      <div class="card">
        <div class="card-title">ç›®å‰å•†å“åˆ—è¡¨ï¼ˆproductï¼‰</div>
        <table>
          <thead>
            <tr>
              <th>è²¨æ¶ç·¨è™Ÿ rack_id</th>
              <th>å•†å“åç¨± name</th>
              <th>æ•¸é‡ number</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="product-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-title" id="product-form-title">æ–°å¢å•†å“</div>
        <div class="form-row">
          <div class="field">
            <label for="table_id">è²¨æ¶ç·¨è™Ÿ rack_id</label>
            <input type="text" id="table_id" placeholder="ä¾‹å¦‚ï¼šA1" />
          </div>
          <div class="field">
            <label for="name">å•†å“åç¨± name</label>
            <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šnoodle" />
          </div>
          <div class="field">
            <label for="number">æ•¸é‡ number</label>
            <input type="number" id="number" placeholder="ä¾‹å¦‚ï¼š10" />
          </div>
        </div>
        <button class="btn btn-primary" id="product-save-btn">å„²å­˜</button>
        <button class="btn btn-secondary" id="product-reset-btn">æ¸…ç©º / æ–°å¢æ¨¡å¼</button>
      </div>

      <div class="card">
        <div class="card-title">
          <span>è²¨æ¶è³‡æ–™ï¼ˆracksï¼‰</span>
          <span class="badge">æ–°å¢ï¼šweight / height / products / drinks</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>rack_id</th>
              <th>weight</th>
              <th>height</th>
              <th>å¯æ”¾ç”¢å“ products</th>
              <th>å¯æ”¾é£²å“ drinks</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="racks-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-title" id="racks-form-title">æ–°å¢è²¨æ¶ï¼ˆracksï¼‰</div>
        <div class="form-row">
          <div class="field">
            <label for="r_rack_id">è²¨æ¶ç·¨è™Ÿ rack_id</label>
            <input type="text" id="r_rack_id" placeholder="ä¾‹å¦‚ï¼šA1" />
          </div>
          <div class="field">
            <label for="t_weight">weightï¼ˆé£²å“ç”¨ï¼‰</label>
            <input type="number" id="t_weight" placeholder="ä¾‹å¦‚ï¼š50" />
          </div>
          <div class="field">
            <label for="t_height">heightï¼ˆé£Ÿç‰©ç”¨ï¼‰</label>
            <input type="number" id="t_height" placeholder="ä¾‹å¦‚ï¼š75" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="t_products">å¯æ”¾é€²çš„é£Ÿç‰©ï¼ˆproducts / foodï¼‰</label>
            <textarea id="t_products" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šnoodle,rice,burger"></textarea>
            <div class="hint">åªå¡«ã€Œé£Ÿç‰©ã€æ™‚ï¼Œæœƒè‡ªå‹•é–ä½ weightï¼Œåªéœ€è¦å¡« heightã€‚</div>
          </div>
          <div class="field">
            <label for="t_drinks">å¯æ”¾é€²çš„é£²å“ï¼ˆdrinksï¼‰</label>
            <textarea id="t_drinks" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼štea,cola,water"></textarea>
            <div class="hint">åªå¡«ã€Œé£²å“ã€æ™‚ï¼Œæœƒè‡ªå‹•é–ä½ heightï¼Œåªéœ€è¦å¡« weightã€‚</div>
          </div>
        </div>

        <button class="btn btn-primary" id="racks-save-btn">å„²å­˜</button>
        <button class="btn btn-secondary" id="racks-reset-btn">æ¸…ç©º / æ–°å¢æ¨¡å¼</button>
      </div>
    </div>

    <div id="status">å°šæœªç™»å…¥</div>
  </div>

  <!-- Modalï¼šé» row é¡¯ç¤º position / racks è³‡è¨Š -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">ä½ç½®è³‡è¨Š</div>
        <button class="modal-close" id="modal-close">é—œé–‰</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcnUT8TN1RuiOBifEqEznRlogNrwX-sI0",
      authDomain: "ntuiot-f7743.firebaseapp.com",
      databaseURL: "https://ntuiot-f7743-default-rtdb.firebaseio.com",
      projectId: "ntuiot-f7743",
      storageBucket: "ntuiot-f7743.firebasestorage.app",
      messagingSenderId: "224195625096",
      appId: "1:224195625096:web:a0bcbefcf733f6b8d35f3d",
      measurementId: "G-VPMLNE6BF5"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    const loginArea   = document.getElementById("login-area");
    const manageArea  = document.getElementById("manage-area");
    const loginEmail  = document.getElementById("login-email");
    const loginPwd    = document.getElementById("login-password");
    const loginBtn    = document.getElementById("login-btn");
    const loginMsg    = document.getElementById("login-msg");
    const statusEl = document.getElementById("status");

    

    // ===== modal (é» row é¡¯ç¤º position) =====
    const overlay = document.getElementById("overlay");
    const modalClose = document.getElementById("modal-close");
    const modalTitle = document.getElementById("modal-title");
    const modalBody  = document.getElementById("modal-body");

    modalClose.addEventListener("click", () => overlay.style.display = "none");
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    // cache ç›®å‰è³‡æ–™ï¼Œè®“é» row æ™‚èƒ½æŸ¥åˆ°å…§å®¹
    let productData = {};
    let racksData = {};
// product
    const productTbody      = document.getElementById("product-tbody");
    const productFormTitle  = document.getElementById("product-form-title");
    const tableInput        = document.getElementById("table_id");
    const nameInput         = document.getElementById("name");
    const numInput          = document.getElementById("number");
    const productSaveBtn    = document.getElementById("product-save-btn");
    const productResetBtn   = document.getElementById("product-reset-btn");

    let currentProductKey = null;
    let productListenerInited = false;

    // racks
    const racksTbody       = document.getElementById("racks-tbody");
    const racksFormTitle   = document.getElementById("racks-form-title");
    const rRackIdInput     = document.getElementById("r_rack_id");
    const tWeightInput     = document.getElementById("t_weight");
    const tHeightInput     = document.getElementById("t_height");
    const tProductsInput   = document.getElementById("t_products");
    const tDrinksInput     = document.getElementById("t_drinks");
    const racksSaveBtn     = document.getElementById("racks-save-btn");
    const racksResetBtn    = document.getElementById("racks-reset-btn");

    let currentRackKey = null;
    let racksListenerInited = false;

    loginBtn.addEventListener("click", async () => {
      loginMsg.textContent = "";
      const email = loginEmail.value.trim();
      const pwd   = loginPwd.value;
      if (!email || !pwd) { loginMsg.textContent = "è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼"; return; }

      try {
        await signInWithEmailAndPassword(auth, email, pwd);
        statusEl.textContent = "ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨è®€å–è³‡æ–™â€¦";
      } catch (err) {
        console.error(err);
        loginMsg.textContent = err?.message || "ç™»å…¥å¤±æ•—";
        statusEl.textContent = "ç™»å…¥å¤±æ•—ï¼š" + (err?.message || "");
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusEl.textContent = "å·²ç™»å…¥ï¼š" + (user.email || "") + "ï¼ˆUID: " + user.uid + "ï¼‰";
        loginArea.style.display  = "none";
        manageArea.style.display = "block";

        if (!productListenerInited) { initProductListener(); productListenerInited = true; }
        if (!racksListenerInited) { initRacksListener(); racksListenerInited = true; }
      } else {
        statusEl.textContent = "å°šæœªç™»å…¥æˆ–å·²ç™»å‡º";
        loginArea.style.display  = "block";
        manageArea.style.display = "none";
      }
    });

    // product
    function initProductListener() {
      const productRef = ref(db, "product");
      onValue(productRef, (snapshot) => {
        const data = snapshot.val() || {};
        productData = data;
        renderProductTable(data);
      }, (error) => {
        console.error(error);
        statusEl.textContent = "è®€å– product å¤±æ•—ï¼š" + error.message;
      });
    }

    function renderProductTable(data) {
      productTbody.innerHTML = "";
      Object.entries(data).forEach(([key, item]) => {
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.key = key;

        const rackId  = (item.rack_id ?? item.table_id ?? "-");
        const name    = item.name ?? "(æœªå‘½å)";
        const qtyNum  = Number(item.number ?? 0);

        let qtyClass = "qty-ok";
        if (qtyNum === 0) qtyClass = "qty-out";
        else if (qtyNum <= 5) qtyClass = "qty-low";

        const restock = (qtyNum === 0) ? `<span class="badge badge-warn">éœ€è¦è£œè²¨</span>` : "";

        tr.innerHTML = `
          <td><span class="badge">${escapeHtml(String(rackId))}</span></td>
          <td>${escapeHtml(name)}</td>
          <td class="${qtyClass}">${qtyNum}${restock}</td>
          <td>
            <button class="btn btn-primary" data-action="edit" data-key="${key}">ä¿®æ”¹</button>
            <button class="btn btn-danger" data-action="delete" data-key="${key}">åˆªé™¤</button>
          </td>
        `;
        
        // é» row é¡¯ç¤º positionï¼ˆä½†é»åˆ°æŒ‰éˆ•ä¸ç®—ï¼‰
        tr.addEventListener("click", (ev) => {
          const target = ev.target;
          if (target instanceof HTMLElement && target.closest("button")) return;
          showPositionFromProductKey(key);
        });

        productTbody.appendChild(tr);
});
    }

    productTbody.addEventListener("click", (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;

      const action = btn.getAttribute("data-action");
      const key    = btn.getAttribute("data-key");
      if (!action || !key) return;

      if (action === "edit") {
        const row = btn.closest("tr");
        const tds = row.querySelectorAll("td");
        tableInput.value = stripBadgeText(tds[0].innerText);
        nameInput.value  = tds[1].innerText.trim();
        numInput.value   = tds[2].innerText.replace("éœ€è¦è£œè²¨","").trim();
        currentProductKey = key;
        productFormTitle.textContent = "ä¿®æ”¹å•†å“";
      }

      if (action === "delete") {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å•†å“å—ï¼Ÿ")) {
          const itemRef = ref(db, "product/" + key);
          remove(itemRef)
            .then(() => { statusEl.textContent = "å·²åˆªé™¤å•†å“"; })
            .catch(err => { console.error(err); statusEl.textContent = "åˆªé™¤å¤±æ•—ï¼š" + err.message; });
        }
      }
    });

    productSaveBtn.addEventListener("click", () => {
      const rackId = tableInput.value.trim();
      const name   = nameInput.value.trim();
      const qty    = Number(numInput.value);

      if (!name) { alert("è«‹è¼¸å…¥å•†å“åç¨±"); return; }

      const payload = {
        rack_id: rackId ? rackId : null,
        name: name,
        number: isNaN(qty) ? 0 : qty,
        id: 0
      };

      if (currentProductKey) {
        update(ref(db, "product/" + currentProductKey), payload)
          .then(() => { statusEl.textContent = "å·²æ›´æ–°å•†å“"; resetProductForm(); })
          .catch(err => { console.error(err); statusEl.textContent = "æ›´æ–°å¤±æ•—ï¼š" + err.message; });
      } else {
        push(ref(db, "product"), payload)
          .then(() => { statusEl.textContent = "å·²æ–°å¢å•†å“"; resetProductForm(); })
          .catch(err => { console.error(err); statusEl.textContent = "æ–°å¢å¤±æ•—ï¼š" + err.message; });
      }
    });

    function resetProductForm() {
      currentProductKey = null;
      tableInput.value = "";
      nameInput.value  = "";
      numInput.value   = "";
      productFormTitle.textContent = "æ–°å¢å•†å“";
    }
    productResetBtn.addEventListener("click", resetProductForm);

    // racks
    function initRacksListener() {
      const racksRef = ref(db, "racks");
      onValue(racksRef, (snapshot) => {
        const data = snapshot.val() || {};
        racksData = data;
        renderRacksTable(data);
        statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
      }, (error) => {
        console.error(error);
        statusEl.textContent = "è®€å– racks å¤±æ•—ï¼š" + error.message;
      });
    }

    function renderRacksTable(data) {
      racksTbody.innerHTML = "";
      Object.entries(data).forEach(([key, item]) => {
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.rackkey = key;

        const rackId   = item.rack_id ?? "-";
        const weight   = item.weight ?? "-";
        const height   = item.height ?? "-";
        const products = Array.isArray(item.products) ? item.products : (item.products ? Object.values(item.products) : []);
        const drinks   = Array.isArray(item.drinks) ? item.drinks : (item.drinks ? Object.values(item.drinks) : []);

        tr.innerHTML = `
          <td><span class="badge">${escapeHtml(String(rackId))}</span></td>
          <td>${escapeHtml(String(weight))}</td>
          <td>${escapeHtml(String(height))}</td>
          <td>${escapeHtml(products.join(", "))}</td>
          <td>${escapeHtml(drinks.join(", "))}</td>
          <td>
            <button class="btn btn-primary" data-action="edit" data-key="${key}">ä¿®æ”¹</button>
            <button class="btn btn-danger" data-action="delete" data-key="${key}">åˆªé™¤</button>
          </td>
        `;
        
        // é» row é¡¯ç¤º positionï¼ˆä½†é»åˆ°æŒ‰éˆ•ä¸ç®—ï¼‰
        tr.addEventListener("click", (ev) => {
          const target = ev.target;
          if (target instanceof HTMLElement && target.closest("button")) return;
          showPositionFromRackKey(key);
        });

        racksTbody.appendChild(tr);
});
    }

    racksTbody.addEventListener("click", (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;

      const action = btn.getAttribute("data-action");
      const key    = btn.getAttribute("data-key");
      if (!action || !key) return;

      if (action === "edit") {
        const row = btn.closest("tr");
        const tds = row.querySelectorAll("td");
        rRackIdInput.value    = stripBadgeText(tds[0].innerText);
        tWeightInput.value    = tds[1].innerText.trim();
        tHeightInput.value    = tds[2].innerText.trim();
        tProductsInput.value  = tds[3].innerText.trim();
        tDrinksInput.value    = tds[4].innerText.trim();

        currentRackKey = key;
        racksFormTitle.textContent = "ä¿®æ”¹è²¨æ¶";
        applyRackInputRules();
      }

      if (action === "delete") {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è²¨æ¶è³‡æ–™å—ï¼Ÿ")) {
          remove(ref(db, "racks/" + key))
            .then(() => { statusEl.textContent = "å·²åˆªé™¤è²¨æ¶"; })
            .catch(err => { console.error(err); statusEl.textContent = "åˆªé™¤å¤±æ•—ï¼š" + err.message; });
        }
      }
    });

    function applyRackInputRules() {
      const hasProducts = parseCsvList(tProductsInput.value).length > 0;
      const hasDrinks   = parseCsvList(tDrinksInput.value).length > 0;

      if (hasDrinks && !hasProducts) {
        tWeightInput.disabled = false;
        tHeightInput.disabled = true;
        tHeightInput.value = "";
      } else if (hasProducts && !hasDrinks) {
        tWeightInput.disabled = true;
        tWeightInput.value = "";
        tHeightInput.disabled = false;
      } else {
        tWeightInput.disabled = false;
        tHeightInput.disabled = false;
      }
    }

    tProductsInput.addEventListener("input", applyRackInputRules);
    tDrinksInput.addEventListener("input", applyRackInputRules);

    racksSaveBtn.addEventListener("click", () => {
      const rackId   = rRackIdInput.value.trim();
      const products = parseCsvList(tProductsInput.value);
      const drinks   = parseCsvList(tDrinksInput.value);

      const needOnlyWeight = (drinks.length > 0 && products.length === 0);
      const needOnlyHeight = (products.length > 0 && drinks.length === 0);

      const weight = needOnlyHeight ? null : Number(tWeightInput.value);
      const height = needOnlyWeight ? null : Number(tHeightInput.value);

      if (!rackId) { alert("è«‹è¼¸å…¥ rack_id"); return; }

      const payload = {
        rack_id: rackId,
        weight: (weight === null || isNaN(weight)) ? null : weight,
        height: (height === null || isNaN(height)) ? null : height,
        products: products,
        drinks: drinks
      };

      if (currentRackKey) {
        update(ref(db, "racks/" + currentRackKey), payload)
          .then(() => { statusEl.textContent = "å·²æ›´æ–°è²¨æ¶"; resetRacksForm(); })
          .catch(err => { console.error(err); statusEl.textContent = "æ›´æ–°å¤±æ•—ï¼š" + err.message; });
      } else {
        push(ref(db, "racks"), payload)
          .then(() => { statusEl.textContent = "å·²æ–°å¢è²¨æ¶è³‡æ–™"; resetRacksForm(); })
          .catch(err => { console.error(err); statusEl.textContent = "æ–°å¢å¤±æ•—ï¼š" + err.message; });
      }
    });

    function resetRacksForm() {
      currentRackKey = null;
      rRackIdInput.value = "";
      tWeightInput.value  = "";
      tHeightInput.value  = "";
      tProductsInput.value = "";
      tDrinksInput.value   = "";
      tWeightInput.disabled = false;
      tHeightInput.disabled = false;
      racksFormTitle.textContent = "æ–°å¢è²¨æ¶ï¼ˆracksï¼‰";
    }
    racksResetBtn.addEventListener("click", resetRacksForm);

    
    // =========================
    // é» row é¡¯ç¤º positionï¼ˆrack_idï¼‰+ å°æ‡‰ racks è³‡è¨Š
    // =========================
    function showPositionFromProductKey(pKey) {
      const item = productData?.[pKey];
      if (!item) return;

      const rackId = String(item?.rack_id ?? item?.table_id ?? "-");
      const name = String(item?.name ?? "(æœªå‘½åå•†å“)");
      const qty  = Number(item?.number ?? 0);

      // æ‰¾å°æ‡‰ rackï¼ˆç”¨ rack_id æ¯”å°ï¼‰
      const rackEntry = Object.values(racksData || {}).find(r => String(r?.rack_id ?? "") === rackId);
      const weight = rackEntry?.weight ?? null;
      const height = rackEntry?.height ?? null;
      const products = Array.isArray(rackEntry?.products) ? rackEntry.products : [];
      const drinks   = Array.isArray(rackEntry?.drinks) ? rackEntry.drinks : [];

      const isDrink = drinks.includes(name);
      const isFood  = products.includes(name);

      modalTitle.textContent = `ä½ç½®è³‡è¨Šï¼ˆproduct â†’ rack_id: ${rackId}ï¼‰`;
      modalBody.innerHTML = `
        <div class="kv">
          <div class="k">å•†å“</div><div class="v">${escapeHtml(name)}</div>
          <div class="k">æ•¸é‡</div><div class="v">${qty}${qty === 0 ? ' <span class="badge badge-warn">éœ€è¦è£œè²¨</span>' : ''}</div>
          <div class="k">ä½ç½®ï¼ˆpositionï¼‰</div><div class="v"><span class="badge">${escapeHtml(rackId)}</span></div>
          <div class="k">åˆ†é¡</div>
          <div class="v">
            ${isDrink ? '<span class="badge">é£²å“</span>' : ''}
            ${isFood ? '<span class="badge">é£Ÿç‰©</span>' : ''}
            ${(!isDrink && !isFood) ? '<span class="badge badge-warn">æœªåœ¨è²¨æ¶æ¸…å–®ä¸­</span>' : ''}
          </div>
          <div class="k">è²¨æ¶ weight</div><div class="v">${weight ?? '-'}</div>
          <div class="k">è²¨æ¶ height</div><div class="v">${height ?? '-'}</div>

          <div class="k">å¯æ”¾é£Ÿç‰©</div>
          <div class="v"><div class="chips">${(products.length ? products : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div></div>

          <div class="k">å¯æ”¾é£²å“</div>
          <div class="v"><div class="chips">${(drinks.length ? drinks : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div></div>
        </div>
      `;
      overlay.style.display = "flex";
    }

    function showPositionFromRackKey(rKey) {
      // racks æ˜¯ç”¨ firebase push key å­˜çš„ï¼Œæ‰€ä»¥è¦å¾ racksData ç›´æ¥å–
      const item = racksData?.[rKey];
      if (!item) return;

      const rackId = String(item?.rack_id ?? "-");
      const weight = item?.weight ?? null;
      const height = item?.height ?? null;
      const products = Array.isArray(item?.products) ? item.products : (item?.products ? Object.values(item.products) : []);
      const drinks   = Array.isArray(item?.drinks) ? item.drinks : (item?.drinks ? Object.values(item.drinks) : []);

      modalTitle.textContent = `ä½ç½®è³‡è¨Šï¼ˆracks â†’ rack_id: ${rackId}ï¼‰`;
      modalBody.innerHTML = `
        <div class="kv">
          <div class="k">ä½ç½®ï¼ˆpositionï¼‰</div><div class="v"><span class="badge">${escapeHtml(rackId)}</span></div>
          <div class="k">weight</div><div class="v">${weight ?? '-'}</div>
          <div class="k">height</div><div class="v">${height ?? '-'}</div>

          <div class="k">å¯æ”¾é£Ÿç‰©</div>
          <div class="v"><div class="chips">${(products.length ? products : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div></div>

          <div class="k">å¯æ”¾é£²å“</div>
          <div class="v"><div class="chips">${(drinks.length ? drinks : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div></div>
        </div>
      `;
      overlay.style.display = "flex";
    }


    function parseCsvList(s) {
      return String(s || "").split(",").map(x => x.trim()).filter(x => x.length > 0);
    }
    function stripBadgeText(s) {
      return String(s || "").replace(/\s+/g, " ").trim();
    }
    function escapeHtml(str) {
      return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
