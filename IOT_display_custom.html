<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åº«å­˜çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 24px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 14px;
      line-height: 1.6;
    }
    a.link {
      color: #2563eb;
      text-decoration: none;
    }
    a.link:hover { text-decoration: underline; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead { background: #f9fafb; }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      color: #4b5563;
    }
    tr:nth-child(even) td { background-color: #fafafa; }
    tr.clickable { cursor: pointer; }
    tr.clickable:hover td { background: #f3f4f6; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }
    .badge-warn {
      background: #fef3c7;
      color: #92400e;
    }
    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .qty-ok  { color: #16a34a; font-weight: 600; }
    .qty-low { color: #f97316; font-weight: 600; }
    .qty-out { color: #dc2626; font-weight: 600; }

    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      width: min(760px, 100%);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
    }
    .modal-close {
      border: none;
      background: #111827;
      color: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-body {
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      font-size: 14px;
    }
    .k { color: #6b7280; }
    .v { color: #111827; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>è²¨æ¶åº«å­˜çœ‹æ¿</h1>
    <div class="subtitle">
      é¡¯ç¤ºç›®å‰æ¯å€‹è²¨æ¶ä¸Šçš„å•†å“èˆ‡å‰©é¤˜æ•¸é‡ï¼ˆRealtime Database å³æ™‚æ›´æ–°ï¼‰<br />
      é»é¸ä»»ä¸€åˆ—å¯é¡¯ç¤ºã€Œä½ç½® / è²¨æ¶è³‡æ–™ï¼ˆpositionï¼‰ã€<br />
      <a class="link" href="IOT_manage_custom.html" target="_blank">ğŸ‘‰ å‰å¾€ç®¡ç†å¾Œå°</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>è²¨æ¶ rack_id</th>
          <th>å•†å“åç¨±</th>
          <th>å‰©é¤˜æ•¸é‡</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="inventory-body"></tbody>
    </table>

    <div id="status">æ­£åœ¨é€£ç·š Firebaseâ€¦</div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">ä½ç½®è³‡è¨Š</div>
        <button class="modal-close" id="modal-close">é—œé–‰</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcnUT8TN1RuiOBifEqEznRlogNrwX-sI0",
      authDomain: "ntuiot-f7743.firebaseapp.com",
      databaseURL: "https://ntuiot-f7743-default-rtdb.firebaseio.com",
      projectId: "ntuiot-f7743",
      storageBucket: "ntuiot-f7743.firebasestorage.app",
      messagingSenderId: "224195625096",
      appId: "1:224195625096:web:a0bcbefcf733f6b8d35f3d",
      measurementId: "G-VPMLNE6BF5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const tbody = document.getElementById("inventory-body");
    const statusEl = document.getElementById("status");

    const overlay = document.getElementById("overlay");
    const modalClose = document.getElementById("modal-close");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");

    modalClose.addEventListener("click", () => overlay.style.display = "none");
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    let productData = {};
    let racksData = {};

    onValue(ref(db, "product"), (snap) => {
      productData = snap.val() || {};
      render();
      statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
    }, (err) => {
      console.error(err);
      statusEl.textContent = "è®€å– product å¤±æ•—ï¼š" + err.message;
    });

    onValue(ref(db, "racks"), (snap) => {
      racksData = snap.val() || {};
      render();
      statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
    }, (err) => {
      console.error(err);
      statusEl.textContent = "è®€å– racks å¤±æ•—ï¼š" + err.message;
    });

    function render() {
      tbody.innerHTML = "";

      const rows = Object.entries(productData || {}).map(([key, item]) => {
        const rackId = (item?.rack_id ?? item?.table_id ?? "-");
        const name = item?.name ?? "(æœªå‘½åå•†å“)";
        const qty = Number(item?.number ?? 0);

        let qtyClass = "qty-ok";
        if (qty === 0) qtyClass = "qty-out";
        else if (qty <= 5) qtyClass = "qty-low";

        let statusHtml = `<span class="badge">æ­£å¸¸</span>`;
        if (qty === 0) statusHtml = `<span class="badge badge-danger">éœ€è¦è£œè²¨</span>`;
        else if (qty <= 5) statusHtml = `<span class="badge badge-warn">å¿«æ²’äº†</span>`;

        return { key, rackId: String(rackId), name: String(name), qty, qtyClass, statusHtml };
      });

      rows.sort((a, b) => (a.rackId.localeCompare(b.rackId, "zh-Hant")) || a.name.localeCompare(b.name, "zh-Hant"));

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.key = r.key;

        tr.innerHTML = `
          <td><span class="badge">${escapeHtml(r.rackId)}</span></td>
          <td>${escapeHtml(r.name)}</td>
          <td class="${r.qtyClass}">${r.qty}</td>
          <td>${r.statusHtml}</td>
        `;

        tr.addEventListener("click", () => showPosition(r.key));
        tbody.appendChild(tr);
      }
    }

    function showPosition(productKey) {
      const item = productData?.[productKey];
      if (!item) return;

      const rackId = String(item?.rack_id ?? item?.table_id ?? "-");
      const name = String(item?.name ?? "(æœªå‘½åå•†å“)");
      const qty = Number(item?.number ?? 0);

      // match rack meta by rack_id
      const rackEntry = Object.values(racksData || {}).find(r => String(r?.rack_id ?? "") === rackId);
      const weight = rackEntry?.weight ?? null;
      const height = rackEntry?.height ?? null;
      const products = Array.isArray(rackEntry?.products) ? rackEntry.products : [];
      const drinks = Array.isArray(rackEntry?.drinks) ? rackEntry.drinks : [];

      const isDrink = drinks.includes(name);
      const isFood = products.includes(name);

      modalTitle.textContent = `ä½ç½®è³‡è¨Šï¼ˆrack_id: ${rackId}ï¼‰`;

      modalBody.innerHTML = `
        <div class="kv">
          <div class="k">å•†å“</div><div class="v">${escapeHtml(name)}</div>
          <div class="k">æ•¸é‡</div><div class="v">${qty}${qty === 0 ? ' <span class="badge badge-danger">éœ€è¦è£œè²¨</span>' : ''}</div>
          <div class="k">ä½ç½®ï¼ˆpositionï¼‰</div><div class="v"><span class="badge">${escapeHtml(rackId)}</span></div>
          <div class="k">åˆ†é¡</div>
          <div class="v">
            ${isDrink ? '<span class="badge">é£²å“</span>' : ''}
            ${isFood ? '<span class="badge">é£Ÿç‰©</span>' : ''}
            ${(!isDrink && !isFood) ? '<span class="badge badge-warn">æœªåœ¨è²¨æ¶æ¸…å–®ä¸­</span>' : ''}
          </div>

          <div class="k">è²¨æ¶ weight</div><div class="v">${weight ?? '-'}${isDrink ? ' <span class="badge">é£²å“ç”¨</span>' : ''}</div>
          <div class="k">è²¨æ¶ height</div><div class="v">${height ?? '-'}${isFood ? ' <span class="badge">é£Ÿç‰©ç”¨</span>' : ''}</div>

          <div class="k">å¯æ”¾é£Ÿç‰©</div>
          <div class="v">
            <div class="chips">${(products.length ? products : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div>
          </div>

          <div class="k">å¯æ”¾é£²å“</div>
          <div class="v">
            <div class="chips">${(drinks.length ? drinks : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div>
          </div>
        </div>
      `;

      overlay.style.display = "flex";
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
