<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åº«å­˜çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 24px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 14px;
      line-height: 1.6;
    }
    a.link {
      color: #2563eb;
      text-decoration: none;
    }
    a.link:hover { text-decoration: underline; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead { background: #f9fafb; }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      color: #4b5563;
    }
    tr:nth-child(even) td { background-color: #fafafa; }
    tr.clickable { cursor: pointer; }
    tr.clickable:hover td { background: #f3f4f6; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }
    .badge-warn {
      background: #fef3c7;
      color: #92400e;
    }
    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .qty-ok  { color: #16a34a; font-weight: 600; }
    .qty-low { color: #f97316; font-weight: 600; }
    .qty-out { color: #dc2626; font-weight: 600; }

    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      width: min(760px, 100%);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
    }
    .modal-close {
      border: none;
      background: #111827;
      color: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-body {
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      font-size: 14px;
    }
    .k { color: #6b7280; }
    .v { color: #111827; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>è²¨æ¶åº«å­˜çœ‹æ¿</h1>
    <div class="subtitle">
      é¡¯ç¤ºç›®å‰æ¯å€‹è²¨æ¶ä¸Šçš„å•†å“èˆ‡å‰©é¤˜æ•¸é‡ï¼ˆRealtime Database å³æ™‚æ›´æ–°ï¼‰<br />
      é»é¸ä»»ä¸€åˆ—å¯é¡¯ç¤ºã€Œä½ç½® / è²¨æ¶è³‡æ–™ï¼ˆpositionï¼‰ã€<br />
      <a class="link" href="IOT_manage_custom.html" target="_blank">ğŸ‘‰ å‰å¾€ç®¡ç†å¾Œå°</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>è²¨æ¶ rack_id</th>
          <th>å•†å“åç¨±</th>
          <th>å‰©é¤˜æ•¸é‡</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="inventory-body"></tbody>
    </table>

    <div id="status">æ­£åœ¨é€£ç·š Firebaseâ€¦</div>
  
    <hr style="margin:18px 0;border:none;border-top:1px solid #e5e7eb;" />
    <h2 style="margin:0 0 10px 0;font-size:18px;">éŠ·å”®åˆ†æï¼ˆä¾ Update_time + sellï¼‰</h2>
    <div style="display:grid;grid-template-columns:1fr;gap:14px;">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
        <label style="font-size:14px;color:#374151;">
          çœ‹æœ€è¿‘
          <select id="days-select" style="margin:0 6px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:10px;">
            <option value="1">ä»Šå¤©</option>
            <option value="7">7 å¤©</option>
            <option value="14">14 å¤©</option>
            <option value="30" selected>30 å¤©</option>
            <option value="99999">å…¨éƒ¨</option>
          </select>
        </label>
        <span id="best-seller" class="badge" style="background:#ecfeff;color:#155e75;">è¨ˆç®—ä¸­â€¦</span>
        <span style="font-size:12px;color:#6b7280;">ï¼ˆsell è¦–ç‚ºè©²ç­†è³‡æ–™çš„éŠ·é‡ï¼›æœƒä¾ Update_time ç¯©é¸ï¼‰</span>
      </div>

      <div style="background:linear-gradient(180deg,#ffffff 0%,#f9fafb 100%);border:1px solid #e5e7eb;border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.04);height:280px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:10px;color:#111827;display:flex;justify-content:space-between;align-items:center;">
          <span>å„å•†å“ç¸½éŠ·é‡ï¼ˆTop 10ï¼‰</span>
          <span style="font-weight:600;font-size:12px;color:#6b7280;">ä¾æ™‚é–“ç¯©é¸åŠ ç¸½</span>
        </div>
        <canvas id="sales-bar"></canvas>
      </div>

      <div style="background:linear-gradient(180deg,#ffffff 0%,#f9fafb 100%);border:1px solid #e5e7eb;border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.04);height:280px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:10px;color:#111827;display:flex;justify-content:space-between;align-items:center;">
          <span>æœ€ä½³å•†å“ï¼šæ¯æ—¥éŠ·é‡è¶¨å‹¢</span>
          <span style="font-weight:600;font-size:12px;color:#6b7280;">æŒ‰æ—¥åŠ ç¸½</span>
        </div>
        <canvas id="sales-line"></canvas>
      </div>
    </div>

  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">ä½ç½®è³‡è¨Š</div>
        <button class="modal-close" id="modal-close">é—œé–‰</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";


    const firebaseConfig = {
      apiKey: "AIzaSyCcnUT8TN1RuiOBifEqEznRlogNrwX-sI0",
      authDomain: "ntuiot-f7743.firebaseapp.com",
      databaseURL: "https://ntuiot-f7743-default-rtdb.firebaseio.com",
      projectId: "ntuiot-f7743",
      storageBucket: "ntuiot-f7743.firebasestorage.app",
      messagingSenderId: "224195625096",
      appId: "1:224195625096:web:a0bcbefcf733f6b8d35f3d",
      measurementId: "G-VPMLNE6BF5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const tbody = document.getElementById("inventory-body");
    const statusEl = document.getElementById("status");

    const overlay = document.getElementById("overlay");
    const modalClose = document.getElementById("modal-close");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");

    modalClose.addEventListener("click", () => overlay.style.display = "none");
    overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.style.display = "none"; });

    let productData = {};
    let racksData = {};

    onValue(ref(db, "product"), (snap) => {
      productData = snap.val() || {};
      render();
      renderAnalytics();
      statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
    }, (err) => {
      console.error(err);
      statusEl.textContent = "è®€å– product å¤±æ•—ï¼š" + err.message;
    });

    onValue(ref(db, "racks"), (snap) => {
      racksData = snap.val() || {};
      render();
      renderAnalytics();
      statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
    }, (err) => {
      console.error(err);
      statusEl.textContent = "è®€å– racks å¤±æ•—ï¼š" + err.message;
    });

    function render() {
      tbody.innerHTML = "";

      // ä¾ (rack_id = product_id) + å•†å“åç¨±(product) å»é‡ï¼Œåªé¡¯ç¤ºæœ€æ–°ä¸€ç­†ï¼ˆUpdate_time æœ€å¤§ï¼‰
      const latestByKey = new Map();

      for (const [key, item] of Object.entries(productData || {})) {
        const rackId = String(item?.product_id ?? "-");
        const name = String(item?.product ?? "(æœªå‘½åå•†å“)");
        const qty = Number(item?.number ?? 0);

        const t = parseUpdateTime(item?.Update_time ?? item?.update_time ?? item?.UpdateTime);
        const groupKey = `${rackId}||${name}`;

        const prev = latestByKey.get(groupKey);
        if (!prev) {
          latestByKey.set(groupKey, { key, rackId, name, qty, time: t, raw: item });
        } else {
          const prevTime = prev.time ? prev.time.getTime() : -Infinity;
          const curTime = t ? t.getTime() : -Infinity;
          if (curTime >= prevTime) {
            latestByKey.set(groupKey, { key, rackId, name, qty, time: t, raw: item });
          }
        }
      }

      const rows = Array.from(latestByKey.values()).map(r0 => {
        const qty = Number(r0.qty ?? 0);

        let qtyClass = "qty-ok";
        if (qty === 0) qtyClass = "qty-out";
        else if (qty <= 5) qtyClass = "qty-low";

        let statusHtml = `<span class="badge">æ­£å¸¸</span>`;
        if (qty === 0) statusHtml = `<span class="badge badge-danger">éœ€è¦è£œè²¨</span>`;
        else if (qty <= 5) statusHtml = `<span class="badge badge-warn">å¿«æ²’äº†</span>`;

        return { ...r0, qty, qtyClass, statusHtml };
      });

      // æœ€æ–°å„ªå…ˆï¼šå…ˆä¾æ™‚é–“å€’åºï¼Œå†ä¾ rackId/name
      rows.sort((a, b) => {
        const at = a.time ? a.time.getTime() : -Infinity;
        const bt = b.time ? b.time.getTime() : -Infinity;
        if (bt !== at) return bt - at;
        return (a.rackId.localeCompare(b.rackId, "zh-Hant")) || a.name.localeCompare(b.name, "zh-Hant");
      });

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.key = r.key;

        tr.innerHTML = `
          <td><span class="badge">${escapeHtml(r.rackId)}</span></td>
          <td>${escapeHtml(r.name)}</td>
          <td class="${r.qtyClass}">${r.qty}</td>
          <td>${r.statusHtml}</td>
        `;

        tr.addEventListener("click", () => showPosition(r.key));
        tbody.appendChild(tr);
      }
    }

    function showPosition(productKey) {
      const item = productData?.[productKey];
      if (!item) return;

      const rackId = String(item?.product_id ?? "-");
const name = String(item?.product ?? "(æœªå‘½åå•†å“)");
const qty = Number(item?.number ?? 0);

      // match rack meta by rack_id
      const rackEntry = Object.values(racksData || {}).find(r => String(r?.rack_id ?? "") === rackId);
      const weight = rackEntry?.weight ?? null;
      const height = rackEntry?.height ?? null;
      const products = Array.isArray(rackEntry?.products) ? rackEntry.products : [];
      const drinks = Array.isArray(rackEntry?.drinks) ? rackEntry.drinks : [];

      const isDrink = drinks.includes(name);
      const isFood = products.includes(name);

      modalTitle.textContent = `ä½ç½®è³‡è¨Šï¼ˆrack_id: ${rackId}ï¼‰`;

      modalBody.innerHTML = `
        <div class="kv">
          <div class="k">å•†å“</div><div class="v">${escapeHtml(name)}</div>
          <div class="k">æ•¸é‡</div><div class="v">${qty}${qty === 0 ? ' <span class="badge badge-danger">éœ€è¦è£œè²¨</span>' : ''}</div>
          <div class="k">æ›´æ–°æ™‚é–“</div><div class="v">${escapeHtml(String(item?.Update_time ?? item?.update_time ?? item?.UpdateTime ?? "-"))}</div>
          <div class="k">ä½ç½®ï¼ˆpositionï¼‰</div><div class="v"><span class="badge">${escapeHtml(rackId)}</span></div>
          <div class="k">åˆ†é¡</div>
          <div class="v">
            ${isDrink ? '<span class="badge">é£²å“</span>' : ''}
            ${isFood ? '<span class="badge">é£Ÿç‰©</span>' : ''}
            ${(!isDrink && !isFood) ? '<span class="badge badge-warn">æœªåœ¨è²¨æ¶æ¸…å–®ä¸­</span>' : ''}
          </div>

          <div class="k">è²¨æ¶ weight</div><div class="v">${weight ?? '-'}${isDrink ? ' <span class="badge">é£²å“ç”¨</span>' : ''}</div>
          <div class="k">è²¨æ¶ height</div><div class="v">${height ?? '-'}${isFood ? ' <span class="badge">é£Ÿç‰©ç”¨</span>' : ''}</div>

          <div class="k">å¯æ”¾é£Ÿç‰©</div>
          <div class="v">
            <div class="chips">${(products.length ? products : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div>
          </div>

          <div class="k">å¯æ”¾é£²å“</div>
          <div class="v">
            <div class="chips">${(drinks.length ? drinks : ['-']).map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join(' ')}</div>
          </div>
        </div>
      `;

      overlay.style.display = "flex";
    }


    // ====== éŠ·å”®åˆ†æï¼ˆChart.jsï¼‰======
    let chartBar = null;
    let chartLine = null;

    const daysSelect = document.getElementById("days-select");
    const bestSellerEl = document.getElementById("best-seller");

    daysSelect?.addEventListener("change", () => renderAnalytics());

    function parseUpdateTime(t) {
      // æ”¯æ´ "YYYY-MM-DD HH:mm:ss" æˆ– ISO å­—ä¸²
      if (!t) return null;
      const s = String(t).trim();
      // "2025-12-16 21:53:53" -> "2025-12-16T21:53:53"
      const isoLike = s.includes("T") ? s : s.replace(" ", "T");
      const d = new Date(isoLike);
      return isNaN(d.getTime()) ? null : d;
    }

    function toYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function filterByDays(records, days) {
      if (!days || days >= 99999) return records;
      const now = new Date();

      // days=1ï¼šåªçœ‹ä»Šå¤©ï¼ˆå¾ä»Šå¤© 00:00:00 åˆ°ç¾åœ¨ï¼‰
      if (days === 1) {
        const start = new Date(now);
        start.setHours(0, 0, 0, 0);
        return records.filter(r => r.time && r.time >= start && r.time <= now);
      }

      const start = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      return records.filter(r => r.time && r.time >= start && r.time <= now);
    }

    function ensureChartJS() { return window.Chart; }

    async function renderAnalytics() {
      try {
        const ChartCtor = ensureChartJS();

        // 1) æŠŠ productData è½‰æˆ records
        const records = Object.values(productData || {}).map(item => {
          const name = String(item?.product ?? "(æœªå‘½åå•†å“)");
          const sell = Number(item?.sell ?? 0);
          const time = parseUpdateTime(item?.Update_time ?? item?.Update_time ?? item?.update_time ?? item?.UpdateTime ?? item?.Update_time);
          // ä½ çš„æ¬„ä½æ˜¯ Update_timeï¼›ä¿éšªèµ·è¦‹å¤šå®¹éŒ¯
          const t2 = time ?? parseUpdateTime(item?.Update_time);
          return { name, sell: isNaN(sell) ? 0 : sell, time: t2 };
        }).filter(r => r.name);

        const days = Number(daysSelect?.value ?? 30);
        const filtered = filterByDays(records, days);

        // 2) èšåˆï¼šæ¯å€‹å•†å“ç¸½éŠ·é‡
        const sumByProduct = new Map();
        for (const r of filtered) {
          const prev = sumByProduct.get(r.name) ?? 0;
          sumByProduct.set(r.name, prev + (r.sell || 0));
        }

        const sorted = Array.from(sumByProduct.entries()).sort((a,b) => b[1] - a[1]);
        const top = sorted.slice(0, 10);

        const best = top[0];
        if (best) {
          bestSellerEl.textContent = `æœ€å¥½è³£ï¼š${best[0]}ï¼ˆç¸½éŠ·é‡ ${best[1]}ï¼‰`;
        } else {
          bestSellerEl.textContent = "æ²’æœ‰å¯åˆ†æçš„è³‡æ–™";
        }

        // 3) Bar chartï¼ˆTop 10ï¼‰
        const barLabels = top.map(x => x[0]);
        const barData = top.map(x => x[1]);

        const barCtx = document.getElementById("sales-bar");
        if (chartBar) chartBar.destroy();
        chartBar = new ChartCtor(barCtx, {
          type: "bar",
          data: {
            labels: barLabels,
            datasets: [{ label: "ç¸½éŠ·é‡", data: barData }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 450 },
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxRotation: 35, minRotation: 0 }
              },
              y: {
                beginAtZero: true,
                grid: { drawBorder: false }
              }
            }
          }
        });

        // 4) Line chartï¼šæœ€ä½³å•†å“æ¯æ—¥éŠ·é‡è¶¨å‹¢
        const bestName = best?.[0];
        const byDay = new Map(); // ymd -> sum
        if (bestName) {
          for (const r of filtered) {
            if (r.name !== bestName) continue;
            const day = r.time ? toYMD(r.time) : "æœªçŸ¥æ—¥æœŸ";
            byDay.set(day, (byDay.get(day) ?? 0) + (r.sell || 0));
          }
        }

        const daySeries = Array.from(byDay.entries()).sort((a,b) => a[0].localeCompare(b[0]));
        const lineLabels = daySeries.map(x => x[0]);
        const lineData = daySeries.map(x => x[1]);

        const lineCtx = document.getElementById("sales-line");
        if (chartLine) chartLine.destroy();
        chartLine = new ChartCtor(lineCtx, {
          type: "line",
          data: {
            labels: lineLabels,
            datasets: [{ label: bestName ? `${bestName} æ¯æ—¥éŠ·é‡` : "æ¯æ—¥éŠ·é‡", data: lineData, tension: 0.25 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            animation: { duration: 450 },
            plugins: {
              legend: { display: true },
              tooltip: { mode: "index", intersect: false }
            },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, grid: { drawBorder: false } }
            },
            elements: {
              line: { tension: 0.35, borderWidth: 2 },
              point: { radius: 3, hoverRadius: 5 }
            }
          }
        });
      } catch (e) {
        console.error(e);
        bestSellerEl.textContent = "åˆ†æå¤±æ•—ï¼ˆChart.js è¼‰å…¥æˆ–è³‡æ–™æ ¼å¼å•é¡Œï¼‰";
      }
    }


    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
